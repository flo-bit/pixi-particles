<html>
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.1.0/pixi.min.js"></script>
    <script src="https://flo-bit.github.io/every-noise/noise.min.js"></script>
    <script src="https://flo-bit.github.io/js-utils/utils.js"></script>

    <script src="../particles.js"></script>
  </head>

  <body style="overflow: hidden; background-color: black">
    <script>
      class PiXI_SCAFFOLD {
        constructor() {
          let w = window.innerWidth,
            h = window.innerHeight;
          this.app = new PIXI.Application();
          this.app.view.style.position = "absolute";
          this.app.view.style.top = "0px";
          this.app.view.style.left = "0px";
          document.body.appendChild(this.app.view);

          this.w = 1000;
          this.h = 1000;
          this.root = new PIXI.Container();
          this.app.stage.addChild(this.root);
          this.windowResized();

          this.keys = {};
          document.addEventListener("keydown", this.keyDown.bind(this));
          document.addEventListener("keyup", this.keyUp.bind(this));
          window.addEventListener("resize", this.windowResized.bind(this));

          this.setupScene();
          let ticker = PIXI.Ticker.shared;
          ticker.add(this.animate.bind(this));
        }

        // rgb to hex, r,g,b in range 0-1
        rgb(r, g, b) {
          r = Math.max(0, Math.min(1, r));
          g = Math.max(0, Math.min(1, g));
          b = Math.max(0, Math.min(1, b));
          return (
            (Math.floor(r * 255) << 16) +
            (Math.floor(g * 255) << 8) +
            Math.floor(b * 255)
          );
        }

        setupScene() {
          /* setup your scene here */
          /* START */
          this.rect = new PIXI.Graphics();
          this.rect.beginFill(0x0000aa);
          this.rect.drawRect(-this.w / 2, -this.h / 2, this.w, this.h);
          this.rect.endFill();
          this.rect.alpha = 0.0;
          this.root.addChild(this.rect);

          this.text = new PIXI.Text("1000", {
            fontFamily: "Arial",
            fontSize: 35,
            fill: 0xffffff,
            align: "left",
          });
          this.text.anchor.x = 1;
          this.text.x = this.w / 2 - 10;
          this.text.y = this.h / 2 - 50;
          this.root.addChild(this.text);

          this.particles = new Particles({ renderer: this.app.renderer });
          this.particles.createEmitter({
            settings: {
              life: Math.random() * 5 + 5,
              color: 0xff0000,
              shouldShrink: true,
              size: Math.random() * 0.8 + 0.5,
              drag: 0.98,
              check: (part) => {
                return !(
                  part.x > -this.w / 2 &&
                  part.x < this.w / 2 &&
                  part.y > -this.h / 2 &&
                  part.y < this.h / 2
                );
              },
            },
            particlesPerSecond: 3000,
            size: 1000,
            type: "box",
          });

          this.noise = new Noise({ scl: 0.001, oct: 3 });
          this.particles.forces.push((part) => {
            let a = this.noise.get(part.x, part.y, 0) * Math.PI * 2;

            let l = part.v.length();
            part.tint = this.rgb(
              Math.abs(part.v.x) / 200,
              (l - 200) / 200,
              Math.abs(part.v.y) / 300
            );

            let r = 7;
            return {
              x: Math.cos(a) * r,
              y: Math.sin(a) * r,
            };
          });
          this.root.addChild(this.particles);
          /* END */
        }
        animate() {
          /* Update your scene here */
          let elapsed = PIXI.Ticker.shared.elapsedMS / 1000.0;
          let total = PIXI.Ticker.shared.lastTime / 1000.0;
          /* START */
          this.text.text = this.particles.children.length;
          this.particles.update(elapsed);
          this.noise.shiftBy(0, 0, elapsed * 100);
          /*this.particles.spawn({
            x: 0,
            y: 0,
            vx: () => (Math.random() - 0.5) * 500,
            vy: () => (Math.random() - 0.5) * 500,
            count: 10,
            life: Math.random() + 1,
          });*/
          /* END */
        }
        resizeRoot() {
          let w = window.innerWidth,
            h = window.innerHeight;
          let scl = Math.min(w / this.w, h / this.h);
          this.root.position.x = w / 2;
          this.root.position.y = h / 2;
          this.root.scale.x = scl;
          this.root.scale.y = scl;
        }
        windowResized() {
          this.app.renderer.resize(window.innerWidth, window.innerHeight);
          this.resizeRoot();
        }
        keyDown(event) {
          this.keys[event.key] = true;
        }
        keyUp(event) {
          this.keys[event.key] = false;
        }
      }
      let app = new PiXI_SCAFFOLD();
    </script>
  </body>
</html>
